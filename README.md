# UpdateDevelNext-
Updater – Система обновлений для проектов DevelNext

DevelNext – это среда разработки, ориентированная на быстрое создание программ, простых 2D игр, функциональных прототипов под Windows/Linux/Mac. Инструментарий среды обеспечивает быстрый старт, легкость в освоении и обучении, он позволяет создавать десктопные программы с помощью языка PHP и различных мастеров и диалогов.

Десктопное GUI

![2017-11-04_16-34-40](https://user-images.githubusercontent.com/61506534/221895993-46418164-1bc2-45cc-8d1c-a16ace09f9c0.png)

С помощью нашего конструктора можно создавать полноценные кросс-платформенные приложения с богатым интерфейсом. Для этого используется технология под названием JavaFX, это фреймворк для GUI под различные платформы. Наш проект использует Java только как платформу, языком программирования DevelNext является PHP, однако есть возможность писать и подключать дополнительные библиотеки написанные на Java, Groovy, Scala и других JVM языках.

Интерфейс строится с помощью удобного визуального редактора. С помощью него можно расставить различные компоненты – кнопки, списки, таблицы, изображения. Компоненты могут быть стилизованы эффектами и анимацией. Например, изображению можно добавить тень, а кнопке добавить анимацию, которая будет менять ее прозрачность при наведении на неё.

![2017-11-04_16-38-22](https://user-images.githubusercontent.com/61506534/221896296-641908e7-4f43-4933-8758-cb5ecfa1d72f.png)

По мере созданий релизов собственного ПО многие разработчики встречаются с проблемой, когда у пользователей установлена неактуальная версия программы. Для DevelNext годных решений я ещё не видел, поэтому решил написать собственный Updater.

Т.к. я за открытое ПО, система обновлений будет завязана на репозитории GitHub (исходники открыты, каждый может переделать под себя), актуальные версии ПО будут искаться и скачиваться с releases указанного репозитория.
Принцип работы такой:

1. Рядом с исполнительным файлом приложения лежит утилита Updater.jar, которая будет отвечать за проверку и установку новых версий.
2. Программа после своего старта запускает Updater.jar, передаёт ему текущую версию и ждёт от него ответа (в фоновом потоке конечно же).
3. Updater проверяет в релизах репозитория github актуальную версию.
4. Если новых версий не найдено – updater закрывается, программа продолжает работу, пользователь никаких лишних сообщений не видит.
5. Если же найдена новая версия, updater спрашивает у пользователя разрешение (без ведома пользователя качать обновы не хорошо), получив добро, закрывает приложение, скачивает файлы с хаба, заменяет их и обратно запускает приложение.
Необходимо завершить работу приложения перед обновлением, чтоб updater смог обновить файлы. Для этого updater отправляет сообщение в stdout, его получает приложение и завершает работу.
Итак начинаем, необходимо скачать содержимое этого репозитория github: https://github.com/TsSaltan/DevelNext-Updater.

Содержимое репозитория:

Папка bundle – пакет с необходимым функционалом
Папка project-updater – исходники проекта Updater, который отвечает за обновление программы, его необходимо собрать в Updater.jar
Папка project-updateMe – исходники демо проекта
Папка demo – собственно демонстрация, запускаем UpdateMe.jar
Последовательность действий:
1. Собираем пакет Updater
2. Собираем приложение Updater.jar
3. Собираем наше приложение, которое будет обновляться
4. Выкладываем обновления на GitHub

Собираем пакет
Для этого нужно перейти в папку bundle и выполнить команду:

```Shell
gradlew bundle
1
gradlew bundle
Для командной строки Windows:

Shell
cd /d path_to_bundle
gradlew bundle
1
2
cd /d path_to_bundle
gradlew bundle ```
Соответственно вместо path_to_bundle – полный путь к папке bundle

![Скриншот 28-02-2023 182038](https://user-images.githubusercontent.com/61506534/221897748-d8e8661f-f3e7-4e86-94bf-6571191d0134.jpg)

 папке bundle\build появится готовый пакет dn-updater-bundle.dnbundle, его нужно будет установить в DN.

Чтоб не ждать перезапуска среды, можно заново открыть проект – так выходит значительно быстрее, пакет при этом будет работать корректно.

Собираем приложение Updater.jar
Для этого открываем проект из папки project-updater
Из подключенных пакетов должны быть Zip (встроен в DN) и Updater (собранный нами ранее).

Открываем код модуля загрузчик, ищем строку

Загрузчик PHP
```
$updater = new GitHubUpdater('TsSaltan', 'DevelNext-Updater');
```

```
$updater = new GitHubUpdater('TsSaltan', 'DevelNext-Updater');
```

И меняем имя пользователя и название репозитория на своё. Для работы демо версии можно оставить эти значения.

Меняем внешний вид формы UpdateForm под себя. Собираем проект в jar приложение. На выходе получаем файл Updater.jar
![3-updater](https://user-images.githubusercontent.com/61506534/221897964-1a5e34a5-4f71-425d-93b5-d9b16b7b1556.jpg)

Добавляем Updater к своему приложению
(на примере проекта updateMe)

Создаём новый проект (или открываем демо проект updateMe), подключаем пакет Updater.
Необходимо завести переменную (а лучше константу), где будет храниться текущая версия программы. Далее обращаемся к методу, который запустит процесс обновления, можно этот код поместить на событие появления главной формы.



```class MainForm extends AbstractForm
{
    /**
     * Текущая версия программы 
     */
    const VERSION = '1.0.0.0';
 
    
    /**
     * @event show 
     */
    function doShow(UXWindowEvent $e = null)
    {    
        // Проверка обновлений
        // Обязательно нужно передать текущую версию программы
        UpdateMe::start(self::VERSION);
    }
}
```

Cобираем программу. Можно в jar, можно в exe (не важно – portable или нет), но обязательно отметить галочку “объединить все исходники в один исполняемый файл”, иначе будут некорректно работать пути в программе, если она запущена от имени администратора. Про это я писал в статье про рабочие директории.

![4-union](https://user-images.githubusercontent.com/61506534/221898253-773d17f2-1f82-4512-9643-e6046d75288b.jpg)

Рядом с исполняемым файлом нужно скопировать файл Updater.jar. Запускаем, проверяем.

Выпускаем обновление
Указываем в проекте новую версию:

```MainFormPHP
    /**
     * Текущая версия программы 
     */
    const VERSION = '2.0.0.0';
1
2
3
4
    /**
     * Текущая версия программы 
     */
    const VERSION = '2.0.0.0'; 
```

Проект с обновлённой программой

Собираем, открываем свой репозиторий, раздел releases, создаём новый релиз с указанием версии, заголовка, описания.

![8-releases](https://user-images.githubusercontent.com/61506534/221898556-6a948955-785e-4e03-88e7-cc9e1f574a52.jpg)

